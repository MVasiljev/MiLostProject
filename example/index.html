<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MiLost WASM Application</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
      }
      h1 {
        color: #333;
      }
      #status {
        color: #666;
        font-style: italic;
      }
      #output {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 3px;
        min-height: 200px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      pre {
        background: #eee;
        padding: 10px;
        border-radius: 3px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <h1>MiLost WASM Application</h1>

    <div class="container">
      <div id="status">Initializing application...</div>
      <div id="output"></div>
    </div>

    <!-- WASM Initialization -->
    <script type="module">
      // Status and output elements
      const status = document.getElementById("status");
      const output = document.getElementById("output");

      // Helper function to log output
      function log(message, isError = false, isSuccess = false) {
        console.log(message);
        const p = document.createElement("p");
        p.textContent = message;
        if (isError) p.className = "error";
        if (isSuccess) p.className = "success";
        output.appendChild(p);
      }

      // Initialize WASM module
      async function initializeWasm() {
        try {
          status.textContent = "Loading WASM module...";
          log("Loading WASM module...");

          // Import WASM from the correct path
          const wasm = await import("/pkg/milost_wasm.js");

          // Initialize the WASM module
          await wasm.default();

          log("WASM module initialized successfully!", false, true);

          // Make WASM module available globally
          window.wasmModule = wasm;
          window.wasmReady = true;

          // Dispatch event to notify that WASM is ready
          window.dispatchEvent(new CustomEvent("wasm-ready"));

          // Test the WASM module
          const testStr = new wasm.Str("Hello from WASM!");
          log(`Test string: ${testStr.unwrap()}`);
          log(`Length: ${testStr.len()}`);
          log(`Uppercase: ${testStr.to_uppercase().unwrap()}`);

          status.textContent =
            "WASM module initialized, loading application...";

          // Now import and initialize the application using the correct path
          try {
            // Modified path to match your actual file location
            const app = await import("/example/dist/src/app.js");

            if (typeof app.initializeExample === "function") {
              log("Initializing application...");
              await app.initializeExample();
              status.textContent = "Application initialized successfully!";
            } else {
              log(
                "Application module loaded, but initializeExample function not found",
                true
              );
              status.textContent = "Application loaded with warnings";
            }
          } catch (appError) {
            log(`Failed to initialize application: ${appError.message}`, true);
            console.error("Application error:", appError);

            // Show detailed error info
            const errorDetails = document.createElement("pre");
            errorDetails.textContent = `Error details:\nMessage: ${
              appError.message
            }\nStack: ${appError.stack || "No stack trace available"}`;
            output.appendChild(errorDetails);

            status.textContent = "Application initialization failed";
          }
        } catch (error) {
          log(`Failed to initialize WASM module: ${error.message}`, true);
          console.error("WASM initialization error:", error);
          status.textContent = "WASM initialization failed";

          // Set error flag
          window.wasmError = error;
        }
      }

      // Start initialization
      initializeWasm();
    </script>
  </body>
</html>
